# Hetuflow Agent-Server 集成测试计划和方案

```text

```

基于对 hetuflow 系统架构的分析，我为您制定了完整的集成测试计划和方案。该方案涵盖端到端测试、负载测试和故障测试三个核心领域。

## 1. 端到端集成测试方案

### 1.1 测试架构设计

**测试环境组成：**

- **hetuflow-server**：作为调度中心和任务分发节点
- **多个 hetuflow-agent**：模拟分布式执行环境
- **PostgreSQL 数据库**：存储任务和状态数据
- **测试协调器**：管理测试流程和结果验证

**通信协议测试：**

- WebSocket 连接建立和维持
- JWE Token 认证机制验证
- 消息序列化/反序列化（JSON 格式）
- 心跳机制和连接恢复

### 1.2 核心测试场景

#### 1.2.1 Agent 注册和认证流程

```
测试步骤：
1. Server 启动并配置 JWE 密钥对
2. 生成 Agent 专用 JWE Token
3. Agent 使用 Token 发起 WebSocket 连接
4. 验证 AgentRegisterRequest/Response 协议
5. 确认 Agent 状态在数据库中正确记录
```

#### 1.2.2 任务完整生命周期测试

```
测试流程：
1. 创建 SchedJob（支持 Cron 和事件触发）
2. Server 调度器生成 SchedTask
3. 负载均衡器选择合适的 Agent
4. 任务分发到 Agent（提前 5 秒策略）
5. Agent 精调度器精确时间触发
6. TaskInstance 执行和状态上报
7. 验证任务结果和日志收集
```

#### 1.2.3 多 Agent 协作测试

```
测试场景：
- 3-5 个 Agent 同时连接
- 并发任务分发和执行
- 负载均衡算法验证
- Agent 能力匹配测试
- 命名空间隔离验证
```

### 1.3 测试数据和验证点

**数据库状态验证：**

- `sched_agents` 表：Agent 注册状态和能力信息
- `sched_jobs` 表：Job 配置和调度策略
- `sched_tasks` 表：任务生成和分发状态
- `sched_task_instances` 表：执行实例和结果

**实时状态验证：**

- WebSocket 连接状态监控
- 任务执行进度跟踪
- 日志流转发验证
- 错误处理和恢复机制

## 2. 负载测试方案

### 2.1 测试目标

- **并发连接能力**：测试 Server 支持的最大 Agent 连接数
- **任务吞吐量**：测试系统的任务处理能力
- **资源使用效率**：监控 CPU、内存、网络使用情况
- **响应时间**：测试任务分发和状态上报的延迟

### 2.2 负载测试场景

#### 2.2.1 连接负载测试

```
测试配置：
- 逐步增加 Agent 连接数：10 → 50 → 100 → 200
- 每个 Agent 模拟不同的能力配置
- 监控 WebSocket 连接建立时间
- 验证心跳机制在高并发下的稳定性
```

#### 2.2.2 任务吞吐量测试

```
测试场景：
- 高频任务创建：每秒 100-1000 个任务
- 不同类型任务混合：Cron、事件触发、API 创建
- 测试调度器的任务生成能力
- 验证负载均衡算法的效率
```

#### 2.2.3 长时间稳定性测试

```
测试配置：
- 持续运行 24-72 小时
- 模拟真实业务负载模式
- 监控内存泄漏和资源累积
- 验证数据库连接池稳定性
```

### 2.3 性能指标和阈值

**关键性能指标（KPI）：**

- Agent 连接建立时间：< 100ms
- 任务分发延迟：< 50ms
- 任务执行精度：± 10ms
- 系统吞吐量：> 1000 tasks/min
- 内存使用增长：< 1MB/hour

## 3. 故障恢复测试方案

### 3.1 网络故障测试

#### 3.1.1 连接中断恢复

```
故障模拟：
- 随机断开 Agent WebSocket 连接
- 模拟网络抖动和延迟
- 测试自动重连机制
- 验证任务状态一致性
```

#### 3.1.2 部分网络分区

```
测试场景：
- 部分 Agent 与 Server 失联
- 验证任务重新分配机制
- 测试 Agent 状态超时处理
- 确保数据一致性
```

### 3.2 组件故障测试

#### 3.2.1 Server 重启恢复

```
测试流程：
1. Server 运行中突然重启
2. 验证 Agent 自动重连
3. 检查未完成任务的恢复
4. 确认调度器状态重建
```

#### 3.2.2 数据库故障处理

```
故障场景：
- 数据库连接中断
- 事务回滚测试
- 连接池耗尽处理
- 数据一致性验证
```

### 3.3 安全故障测试

#### 3.3.1 认证失败处理

```
测试场景：
- 无效 JWE Token 连接尝试
- Token 过期处理
- 权限不足的操作尝试
- 恶意消息格式测试
```

#### 3.3.2 资源耗尽保护

```
保护机制测试：
- 任务队列溢出处理
- 内存使用限制
- 并发连接数限制
- 恶意大量连接防护
```

## 4. 测试环境和工具要求

### 4.1 测试基础设施

**硬件要求：**

- 测试服务器：8 核 CPU，16GB 内存
- 网络环境：千兆局域网
- 存储：SSD 硬盘，支持高 IOPS

**软件环境：**

- Rust 工具链（与项目版本一致）
- PostgreSQL 数据库
- Docker 容器化部署
- 监控工具：Prometheus + Grafana

### 4.2 测试工具和框架

**集成测试框架：**

```rust
// 基于现有的测试结构扩展
// 使用 tokio-test 进行异步测试
// 集成 testcontainers 管理数据库
// 使用 wiremock 模拟外部依赖
```

**负载测试工具：**

- 自定义 Rust 负载生成器
- 基于 tokio 的并发连接模拟
- 集成系统资源监控

**故障注入工具：**

- 网络故障：tc (traffic control)
- 进程管理：systemd/supervisor
- 资源限制：cgroups

### 4.3 测试数据管理

**测试数据策略：**

- 使用 Docker Compose 管理测试环境
- 数据库迁移脚本自动化
- 测试数据清理和重置机制
- 测试结果持久化和分析

**监控和日志：**

- 结构化日志收集（基于 tracing）
- 实时性能指标监控
- 测试报告自动生成
- 故障场景录制和回放

## 5. 实施计划

### 5.1 开发阶段

1. **第一阶段**：端到端基础测试框架（2 周）
2. **第二阶段**：负载测试工具开发（1 周）
3. **第三阶段**：故障注入机制实现（1 周）
4. **第四阶段**：测试用例完善和优化（1 周）

### 5.2 执行阶段

1. **功能验证**：基础集成测试执行
2. **性能基准**：负载测试和性能调优
3. **稳定性验证**：故障恢复测试
4. **持续集成**：自动化测试流水线

这个集成测试方案充分考虑了 hetuflow 的分布式架构特点，涵盖了从基础功能到高级场景的全面测试，确保系统在各种条件下的可靠性和性能表现。
