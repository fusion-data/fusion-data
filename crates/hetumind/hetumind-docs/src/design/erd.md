# E-R

## hetumind sql

[`hetumind.sql`](../../scripts/software/postgres/sqls/hetumind.sql) 文件是一个完整的 n8n 工作流自动化平台的数据库架构。

1. 核心工作流相关表：（v0.1）

- `workflow_entity`: 工作流主表

  - 存储工作流的基本信息，包括名称、节点配置、连接关系等
  - 包含 `nodes`、`connections`、`settings` 等 JSON 字段存储工作流配置
  - 支持版本控制（`version_id`）
  - 可以归档（`is_archived`）

- `workflow_history`: 工作流历史版本
  - 记录工作流的版本历史
  - 存储作者信息和修改时间
  - 保存历史版本的节点和连接配置

2. 执行相关表：（v0.1）

- `execution_entity`: 工作流执行记录

  - 记录每次工作流执行的详细信息
  - 包含执行状态、开始时间、结束时间等
  - 支持重试机制（`retry_of`、`retry_success_id`）

- `execution_data`: 执行数据
  - 存储工作流执行过程中的数据
  - 包含工作流数据（`workflow_data`）和具体执行数据（`data`）

3. 用户和权限相关表：（v0.1）

- `user`: 用户表

  - 存储用户基本信息
  - 支持 MFA 认证
  - 包含用户角色和设置

- `project_relation`: 项目关系表
  - 管理用户与项目的关联关系
  - 定义用户在项目中的角色

4. 项目和组织相关表：（v0.1）

- `project`: 项目表

  - 存储项目基本信息
  - 包含项目类型和图标

_TODO 考虑使用 workflow_tag + project 来实现更灵活的流程分类，不需要 `folder`_

- `folder`:
  - 支持项目内的文件夹结构
  - 实现文件夹的层级关系

5. 测试相关表：（v1）

- `test_definition`: 测试定义

  - 定义工作流的测试用例
  - 包含测试名称、描述等

- `test_run`: 测试运行记录
  - 记录测试执行的结果
  - 包含通过/失败用例统计

6. 其他重要表：（v0.1）

- `credentials_entity`: 凭证管理

  - 存储各种认证凭证，如：LLM 平台的 api_key
  - 支持不同类型的凭证

- `webhook_entity`: Webhook 配置

  - 管理工作流的 Webhook 端点
  - 包含路径、方法等信息

- `tag_entity`: 标签管理
  - 支持工作流和文件夹的标签功能
  - 实现分类管理

7. 工作流洞察（v1）
   让我为您分析 n8n 中 insights 相关表的作用。从数据库结构来看，insights 主要用于工作流的性能监控和数据分析。具体包含以下几个表：

   1. `insights_metadata` 表：

   - 存储工作流和项目的基本元数据
   - 包含 `workflow_id`、`project_id`、`workflow_name`、`project_name` 等字段
   - 作为其他 insights 表的基础表

   2. `insights_by_period` 表：

   - 按时间段统计工作流的性能指标
   - 包含以下统计类型（type 字段）：
     - 0: 节省的时间（分钟）
     - 1: 运行时间（毫秒）
     - 2: 成功次数
     - 3: 失败次数
   - 支持不同的统计周期（period_unit 字段）：
     - 0: 小时
     - 1: 天
     - 2: 周

   3. `insights_raw` 表：

   - 存储原始的详细执行数据
   - 记录每个执行实例的具体指标
   - 包含相同类型的统计指标（type 字段）：
     - 0: 节省的时间
     - 1: 运行时间
     - 2: 成功
     - 3: 失败
   - 记录具体的时间戳

   这些表的主要作用是：

   1. 性能监控：

   - 跟踪工作流的执行时间
   - 监控工作流的成功率
   - 分析工作流的效率

   2. 数据分析：

   - 提供按时间维度的统计分析
   - 支持不同粒度的数据聚合
   - 帮助识别性能瓶颈

   3. 效率评估：

   - 计算工作流节省的时间
   - 评估自动化带来的效益
   - 优化工作流性能

   4. 问题诊断：

   - 记录失败情况
   - 追踪错误模式
   - 帮助排查问题

   这种设计使得 n8n 能够：

   1. 提供详细的工作流性能报告
   2. 帮助用户优化工作流效率
   3. 监控系统运行状况
   4. 评估自动化带来的价值
   5. 支持数据驱动的决策

   这些 insights 数据对于企业用户特别有价值，可以帮助他们：

   - 评估自动化项目的 ROI
   - 识别需要优化的工作流
   - 监控系统健康状态
   - 制定性能改进计划

主要特点：

1. 完整的工作流生命周期管理
2. 强大的版本控制功能
3. 完善的权限管理系统
4. 支持测试和监控
5. 灵活的凭证管理
6. 支持 Webhook 集成
7. 良好的组织架构支持

这个数据库结构设计得非常完整，能够支持 n8n 作为一个企业级工作流自动化平台的各种功能需求。
